{"version":3,"sources":["../../src/components/pending-balanced-requester.js"],"names":["Requester","require","_","uuid","module","exports","PendingBalancedRequester","constructor","advertisement","discoveryOptions","sock","on","v4","send","args","socks","length","forEach","s","count","callbacks","cb","n","indexOf","minBy","rv","prototype","apply","sentSock","cbId","identity","ids"],"mappings":";;AAAA,MAAMA,SAAS,GAAGC,OAAO,CAAC,aAAD,CAAzB;;AACA,MAAMC,CAAC,GAAGD,OAAO,CAAC,QAAD,CAAjB;;AACA,MAAME,IAAI,GAAGF,OAAO,CAAC,MAAD,CAApB;;AAEAG,MAAM,CAACC,OAAP,GAAiB,MAAMC,wBAAN,SAAuCN,SAAvC,CAAiD;AAC9DO,EAAAA,WAAW,CAACC,aAAD,EAAgBC,gBAAhB,EAAkC;AACzC,UAAMD,aAAN,EAAqBC,gBAArB;AAEA,SAAKC,IAAL,CAAUC,EAAV,CAAa,SAAb,EAAwB,UAASD,IAAT,EAAe;AACnCA,MAAAA,IAAI,CAACP,IAAL,GAAYA,IAAI,CAACS,EAAL,EAAZ;AACH,KAFD;AAGH;;AAEDC,EAAAA,IAAI,CAAC,GAAGC,IAAJ,EAAU;AACV,UAAMJ,IAAI,GAAG,KAAKA,IAAlB;;AAEA,QAAIA,IAAI,CAACK,KAAL,CAAWC,MAAf,EAAuB;AACnBN,MAAAA,IAAI,CAACK,KAAL,CAAWE,OAAX,CAAmB,UAASC,CAAT,EAAY;AAC3BA,QAAAA,CAAC,CAACC,KAAF,GAAU,CAAV;AACH,OAFD;;AAIAjB,MAAAA,CAAC,CAACe,OAAF,CAAUP,IAAI,CAACU,SAAf,EAA0B,UAASC,EAAT,EAAa;AACnCA,QAAAA,EAAE,CAACX,IAAH,IAAWW,EAAE,CAACX,IAAH,CAAQS,KAAR,EAAX;AACH,OAFD;;AAIAT,MAAAA,IAAI,CAACY,CAAL,GAASZ,IAAI,CAACK,KAAL,CAAWQ,OAAX,CAAmBrB,CAAC,CAACsB,KAAF,CAAQd,IAAI,CAACK,KAAb,EAAoB,OAApB,CAAnB,CAAT;AACH;;AAED,UAAMU,EAAE,GAAGzB,SAAS,CAAC0B,SAAV,CAAoBb,IAApB,CAAyBc,KAAzB,CAA+B,IAA/B,EAAqCb,IAArC,CAAX;AAEA,QAAI,CAACJ,IAAI,CAACK,KAAL,CAAWC,MAAhB,EAAwB,OAAOS,EAAP;AAExB,UAAMG,QAAQ,GAAGlB,IAAI,CAACK,KAAL,CAAWL,IAAI,CAACY,CAAL,GAAS,CAApB,CAAjB;AAEA,UAAMO,IAAI,GAAGnB,IAAI,CAACoB,QAAL,GAAgB,GAAhB,IAAuBpB,IAAI,CAACqB,GAAL,GAAW,CAAlC,CAAb;AACArB,IAAAA,IAAI,CAACU,SAAL,CAAeS,IAAf,EAAqBnB,IAArB,GAA4BkB,QAA5B;AAEA,WAAOH,EAAE,IAAIG,QAAQ,CAACzB,IAAtB;AACH;;AAlC6D,CAAlE","sourcesContent":["const Requester = require('./requester');\nconst _ = require('lodash');\nconst uuid = require('uuid');\n\nmodule.exports = class PendingBalancedRequester extends Requester {\n    constructor(advertisement, discoveryOptions) {\n        super(advertisement, discoveryOptions);\n\n        this.sock.on('connect', function(sock) {\n            sock.uuid = uuid.v4();\n        });\n    };\n\n    send(...args) {\n        const sock = this.sock;\n\n        if (sock.socks.length) {\n            sock.socks.forEach(function(s) {\n                s.count = 0;\n            });\n\n            _.forEach(sock.callbacks, function(cb) {\n                cb.sock && cb.sock.count++;\n            });\n\n            sock.n = sock.socks.indexOf(_.minBy(sock.socks, 'count'));\n        }\n\n        const rv = Requester.prototype.send.apply(this, args);\n\n        if (!sock.socks.length) return rv;\n\n        const sentSock = sock.socks[sock.n - 1];\n\n        const cbId = sock.identity + ':' + (sock.ids - 1);\n        sock.callbacks[cbId].sock = sentSock;\n\n        return rv || sentSock.uuid;\n    };\n};\n"],"file":"pending-balanced-requester.js"}