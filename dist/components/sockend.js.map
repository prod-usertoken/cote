{"version":3,"sources":["../../src/components/sockend.js"],"names":["Subscriber","require","Requester","Configurable","Component","module","exports","Sockend","constructor","io","advertisement","discoveryOptions","originalKey","key","requesterTransformators","startDiscovery","namespaces","discovery","on","obj","axon_type","Array","isArray","respondsTo","namespace","normalizedNamespace","requester","name","originalRequestOnAdded","onAdded","bind","requesterSocketHandler","socket","forEach","topic","data","cb","type","transFn","send","server","of","sId","sockets","publisherNamespaces","subscriber","subscribesTo","broadcasts","onMonitorAdded","event","split","length","slice","join","emitter","__room","__rooms","Set","add","rooms","room","to","emit"],"mappings":"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","sourcesContent":["const Subscriber = require('./subscriber');\nconst Requester = require('./requester');\nconst Configurable = require('./configurable');\nconst Component = require('./component');\n\nmodule.exports = class Sockend extends Configurable(Component) {\n    constructor(io, advertisement, discoveryOptions) {\n        const originalKey = advertisement.key;\n        super(advertisement, discoveryOptions);\n\n        this.requesterTransformators = [];\n\n        this.startDiscovery();\n\n        const namespaces = {};\n\n        this.discovery.on('added', (obj) => {\n            if (obj.advertisement.axon_type != 'rep') return;\n            if (obj.advertisement.key != this.advertisement.key) return;\n            if (!Array.isArray(obj.advertisement.respondsTo)) return;\n\n            const namespace = obj.advertisement.namespace;\n            const normalizedNamespace = namespace || '';\n\n            if (namespaces['/' + normalizedNamespace]) return;\n\n            namespaces['/' + normalizedNamespace] = true;\n            obj.namespace = namespace;\n\n            const requester = new Requester({\n                name: 'sockendReq',\n                namespace,\n                key: originalKey,\n            }, discoveryOptions);\n            obj.requester = requester;\n\n            const originalRequestOnAdded = requester.onAdded.bind(requester);\n            requester.onAdded = (obj) => {\n                if (!Array.isArray(obj.advertisement.respondsTo)) return;\n                originalRequestOnAdded(obj);\n            };\n\n            obj.requesterSocketHandler = (socket) => {\n                obj.advertisement.respondsTo.forEach((topic) => {\n                    socket.on(topic, (data, cb) => {\n                        if (typeof data == 'function' && typeof cb == 'undefined') {\n                            cb = data;\n                            data = {};\n                        }\n\n                        data.type = topic;\n\n                        this.requesterTransformators.forEach((transFn) => transFn(data, socket));\n\n                        requester.send(data, cb);\n                    });\n                });\n            };\n\n            let server = io.of('/');\n            if (namespace) server = io.of('/' + namespace);\n            server.on('connection', obj.requesterSocketHandler);\n\n            for (const sId in server.sockets) {\n                obj.requesterSocketHandler(server.sockets[sId]);\n            }\n        });\n\n        const publisherNamespaces = {};\n\n        this.discovery.on('added', (obj) => {\n            if (obj.advertisement.axon_type != 'pub-emitter') return;\n            if (obj.advertisement.key != this.advertisement.key) return;\n\n            const namespace = obj.advertisement.namespace;\n            const normalizedNamespace = namespace || '';\n\n            if (publisherNamespaces['/' + normalizedNamespace]) return;\n\n            publisherNamespaces['/' + normalizedNamespace] = true;\n            obj.namespace = namespace;\n\n            const subscriber = new Subscriber({\n                name: 'sockendSub',\n                namespace: namespace,\n                key: originalKey,\n                subscribesTo: obj.advertisement.broadcasts,\n            }, discoveryOptions);\n\n            subscriber.onMonitorAdded = () => {\n            };\n\n            obj.subscriber = subscriber;\n\n            subscriber.on('**', function(data) {\n                /* eslint-disable no-invalid-this */\n                if (this.event == 'cote:added' || this.event == 'cote:removed') return;\n\n                let topic = this.event.split('::');\n                let namespace = '';\n                if (topic.length > 1) {\n                    namespace += '/' + topic[0];\n                    topic = topic.slice(1);\n                }\n                topic = topic.join('');\n\n                const emitter = io.of(namespace);\n                if (data.__room) {\n                    data.__rooms = new Set(data.__rooms || []);\n                    data.__rooms.add(data.__room);\n                    delete data.__room;\n                }\n                if (data.__rooms) {\n                    const rooms = data.__rooms;\n                    delete data.__rooms;\n                    rooms.forEach((room) => {\n                        emitter.to(room).emit(topic, data);\n                    });\n                } else {\n                    emitter.emit(topic, data);\n                }\n            });\n        });\n    };\n\n    get type() {\n        return 'sockend';\n    }\n};\n"],"file":"sockend.js"}