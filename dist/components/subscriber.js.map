{"version":3,"sources":["../../src/components/subscriber.js"],"names":["Configurable","require","Monitorable","Component","axon","module","exports","Subscriber","constructor","advertisement","discoveryOptions","startDiscovery","sock","types","type","set","subscribesTo","forEach","topic","namespace","on","args","length","unshift","substr","emit","onAdded","obj","address","useHostNames","hostName","alreadyConnected","socks","some","s","_host","remoteAddress","remotePort","port","connect","listener","formatTypeWithNamespace","oppo"],"mappings":"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","sourcesContent":["const Configurable = require('./configurable');\nconst Monitorable = require('./monitorable');\nconst Component = require('./component');\nconst axon = require('@dashersw/axon');\n\nmodule.exports = class Subscriber extends Monitorable(Configurable(Component)) {\n    constructor(advertisement, discoveryOptions) {\n        super(advertisement, discoveryOptions);\n\n        this.startDiscovery();\n\n        this.sock = new axon.types[this.type]();\n        this.sock.sock.set('retry timeout', 0);\n\n        this.advertisement.subscribesTo = this.advertisement.subscribesTo || ['*'];\n\n        this.advertisement.subscribesTo.forEach((topic) => {\n            let namespace = '';\n            if (this.advertisement.namespace) {\n                namespace = this.advertisement.namespace + '::';\n            }\n\n            topic = 'message::' + namespace + topic;\n\n            ((topic) => {\n                this.sock.on(topic, (...args) => {\n                    if (args.length == 1) {\n                        args.unshift(topic.substr(9));\n                    } else {\n                        args[0] = namespace + args[0];\n                    }\n                    this.emit(...args);\n                });\n            })(topic);\n        });\n    }\n\n    onAdded(obj) {\n        super.onAdded(obj);\n\n        const address = this.constructor.useHostNames ? obj.hostName : obj.address;\n\n        const alreadyConnected = this.sock.sock.socks.some((s) =>\n            (this.constructor.useHostNames ? s._host == obj.hostName : s.remoteAddress == address) &&\n            s.remotePort == obj.advertisement.port);\n\n        if (alreadyConnected) return;\n\n        this.sock.connect(obj.advertisement.port, address);\n    }\n\n    on(type, listener) {\n        return super.on(this.formatTypeWithNamespace(type), listener);\n    }\n\n    formatTypeWithNamespace(type) {\n        let namespace = '';\n        if (this.advertisement.namespace) {\n            namespace = this.advertisement.namespace + '::';\n        }\n\n        return namespace + type;\n    }\n\n    get type() {\n        return 'sub-emitter';\n    }\n\n    get oppo() {\n        return 'pub-emitter';\n    }\n};\n"],"file":"subscriber.js"}